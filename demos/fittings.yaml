---
# fittings to be deployed, managed, and destroyed in the cloud infrastructure of Dimension Data

# in safe mode no change is actually made on the infrastructure
safeMode: False

#
polishers:
  - ansible:
      reap: gigafox_inventory.yaml
  - rub:
      key: ~/.ssh/id_rsa.pub
      reap: gigafox_rubs.yaml

# each facility is described separately
---
# Amsterdam - primary site in Europe
locationId: EU7
regionId: dd-eu

rub:
  - beachhead: 10.10.10.9
  - beachhead: 10.10.10.10

basement: beachhead

blueprints:

  # root resources
  - beachhead:
      domain: &domain
        name: Gigafox
        description: '#eu #primary'
        service: advanced
        ipv4: 4
      ethernet: &control
        name: gigafox.control
        description: '#ops'
        subnet: 10.0.0.0
      nodes:
        - beachhead:
            description: '#beachhead #eu #ops'
            glue:
              - internet 22
            running: always
            monitoring: essentials

  # management, administration, and monitoring
  - control:
      domain: *domain
      ethernet: *control
      nodes:
        - stackstorm:
            description: '#stackstorm #eu #ops'
            glue:
              - internet 22 80 443
            running: always
            monitoring: essentials
        - zabbix:
            description: '#dashboard #eu #ops'
            appliance: 'RedHat 6 64-bit 2 CPU'
            monitoring: essentials
        - scom:
            description: 'Microsoft System Center Operation Manager #scom #eu #ops'
            appliance: 'Win2012 R2 Std 4 CPU'
            monitoring: essentials

  # workloads dedicated to source code and related
  - source:
      domain: *domain
      ethernet:
        name: gigafox.source
        description: '#eu #dev'
        subnet: 10.1.0.0
      nodes:
        - gitlab:
            description: '#gitlab #eu #dev'
            glue:
              - internet 80 443
              - gigafox.control
            monitoring: essentials

  # workloads dealing directly with end-user devices
  - web:
      domain: *domain
      ethernet: &bastion
        name: gigafox.web
        description: '#eu #ops'
        subnet: 10.2.0.0
        accept:
          - gigafox.control
      nodes:
        - web[1..2]_eu7:
            description: '#apache #eu #ops #primary'
#            cpu: 4
#            memory: 8
#            disks:
#              - 500 STANDARD
#              - 100 HIGHPERFORMANCE
            glue:
              - internet 22 80 443
            monitoring: essentials
            rub:
              - run rub.update.sh
              - put rub.puppet.apache.pp /root/apache.pp
              - run rub.puppet.sh /root/apache.pp
      balancer:
        port: 80
        protocol: http

  # workloads dealing with short-term memory
  - memcache:
      domain: *domain
      ethernet: *bastion
      nodes:
        - redis[1..2]_eu7:
            description: '#redis #eu #ops #primary'
            monitoring: essentials

  # docker resources
  - docker:
      domain: *domain
      ethernet: &compute
        name: gigafox.compute
        description: '#eu'
        subnet: 10.3.0.0
        accept:
          - gigafox.web
      nodes:
        - docker[1..5]_eu7:
            description: '#docker #eu #dev #ops #primary'
            glue:
              - gigafox.control
            monitoring: essentials
            rub:
              - run rub.update.sh
              - run rub.docker.sh

  # nodejs resources
  - nodejs:
      domain: *domain
      ethernet: *compute
      nodes:
        - nodejs[1..5]_eu7:
            description: '#nodejs #eu #ops #primary'
            glue:
              - gigafox.control
            monitoring: essentials
            rub:
              - run rub.update.sh

  # workloads dedicated to data records
  - sql:
      domain: *domain
      ethernet: &data
        name: data
        description: '#eu'
        subnet: 10.4.0.0
        accept:
          - gigafox.control
          - gigafox.compute
      nodes:
        - masterSQL_eu7:
            description: '#mysql #eu #ops #primary'
            appliance: 'RedHat 6 64-bit 4 CPU'
            monitoring: advanced

  # workloads dedicated to big data
  - cassandra:
      domain: *domain
      ethernet: *data
      nodes:
        - cassandra[1..3]_eu7:
            description: '#cassandra #eu #ops #primary'
            monitoring: essentials

  # workloads dedicated to BLOBs
  - mongodb:
      domain: *domain
      ethernet: *data
      nodes:
        - mongodb[1..7]_eu7:
            description: '#mongodb #eu #ops #primary'
            monitoring: essentials

  # workloads devoted to object-based storage
  - s3:
      domain: *domain
      ethernet: *data
      nodes:
        - ceph[1..5]_eu7:
            description: '#ceph #eu #ops #primary'
            monitoring: essentials

---
# Frankfurt - secondary site in Europe
locationId: EU6
regionId: dd-eu

blueprints:

  # workloads dealing directly with end-user devices
  - web:
      domain: &domain
        name: Gigafox
        description: '#eu #secondary'
        service: advanced
        ipv4: 4
      ethernet: &bastion
        name: gigafox.web
        description: '#eu #ops'
        subnet: 10.2.0.0
        accept:
          - EU7::gigafox.control
      nodes:
        - web[1..2]_eu6:
            description: '#apache #eu #ops #secondary'
#            cpu: 4
#            memory: 8
#            disks:
#              - 500 STANDARD
#              - 100 HIGHPERFORMANCE
            monitoring: essentials
            rub:
              - run rub.update.sh
              - put rub.puppet.apache.pp /root/apache.pp
              - run rub.puppet.sh /root/apache.pp
      balancer:
        port: 80
        protocol: http

  # workloads dealing with short-term memory
  - memcache:
      domain: *domain
      ethernet: *bastion
      nodes:
        - redis[1..2]_eu6:
            description: '#redis #eu #ops #secondary'
            monitoring: essentials

  # docker resources
  - docker:
      domain: *domain
      ethernet: &compute
        name: gigafox.compute
        description: '#eu'
        subnet: 10.3.0.0
        accept:
          - EU7::gigafox.control
      nodes:
        - docker[1..5]_eu6:
            description: '#docker #eu #dev #ops #secondary'
            monitoring: essentials
            rub:
              - run rub.update.sh
              - run rub.docker.sh

  # nodejs resources
  - nodejs:
      domain: *domain
      ethernet: *compute
      nodes:
        - nodejs[1..5]_eu6:
            description: '#nodejs #eu #ops #secondary'
            monitoring: essentials
            rub:
              - run rub.update.sh

  # workloads dedicated to data records
  - sql:
      domain: *domain
      ethernet: &data
        name: data
        description: '#eu'
        subnet: 10.4.0.0
        accept:
          - EU7::gigafox.control
      nodes:
        - slaveSQL_eu6:
            description: '#mysql #eu #ops #secondary'
            appliance: 'RedHat 6 64-bit 4 CPU'
            monitoring: advanced

  # workloads dedicated to big data
  - cassandra:
      domain: *domain
      ethernet: *data
      nodes:
        - cassandra[1..3]_eu6:
            description: '#cassandra #eu #ops #secondary'
            monitoring: essentials

  # workloads dedicated to BLOBs
  - mongodb:
      domain: *domain
      ethernet: *data
      nodes:
        - mongodb[1..7]_eu6:
            description: '#mongodb #eu #ops #secondary'
            monitoring: essentials

  # workloads devoted to object-based storage
  - s3:
      domain: *domain
      ethernet: *data
      nodes:
        - ceph[1..5]_eu6:
            description: '#ceph #eu #ops #secondary'
            monitoring: essentials
