---
safeMode: false

# these directives apply to all nodes created by plumbery
#
cloud-config:

  # this key will be randomly generated by plumbery on first action on this
  # fittings plan, and remembered afterwards
  #
  ssh_keys:
    rsa_private: |
      {{ key.rsa_private }}
    rsa_public: "{{ key.rsa_public }}"

  # let cloud-init do its job depending on target operating system
  #
  users:
    - default

    # for ubuntu nodes, ensure that account ubuntu can do everything
    #
    - name: ubuntu
      sudo: 'ALL=(ALL) NOPASSWD:ALL'
      ssh-authorized-keys:
        - "{{ key.rsa_public }}"
        - "{{ local.rsa_public }}"

    # configure SSH keys for the account root
    #
    - name: root
      ssh-authorized-keys:
        - "{{ key.rsa_public }}"
        - "{{ local.rsa_public }}"

  # plumbery uses the account root to rub nodes
  #
  disable_root: false

  # plumbery can use ssh certificate to avoid passwords
  #
  ssh_pwauth: false

---
locationId: AU10
regionId: dd-au

blueprints:

  - swarm: queen bees

  - queen: # the master node for the full swarm

      domain: &domain
        name: DockerSwarmFox
        description: "Demonstration of a Docker swarm"
        ipv4: auto

      ethernet: &ethernet
        name: dockerSwarmNetwork
        subnet: 10.0.0.0

      nodes:
        - queen:

            description: "#queen #docker #swarm #ubuntu"

            information:
              - "this is a Docker queen server of the full swarm"
              - "connect remotely with:"
              - "$ ssh ubuntu@{{ queen.public }}"
              - "check swarm status with:"
              - "$ docker -H :4000 info"
              - "run hello world somewhere with:"
              - "$ docker -H :4000 run hello-world"
              - "check which node is running hello world with:"
              - "$ docker -H :4000 ps"

            appliance: 'Ubuntu 14'

            cpu: 8
            memory: 32

            glue:
              - internet 22

            monitoring: essentials

            cloud-config:

              hostname: "{{ node.name }}"

              packages:
                - ntp

              write_files:

                - path: /root/hosts.awk
                  content: |
                    #!/usr/bin/awk -f
                    /^{{ queen.private }}/ {next}
                    /^{{ bee1.private }}/ {next}
                    /^{{ bee2.private }}/ {next}
                    /^{{ bee3.private }}/ {next}
                    /^{{ bee4.private }}/ {next}
                    /^{{ bee5.private }}/ {next}
                    /^{{ bee6.private }}/ {next}
                    /^{{ bee7.private }}/ {next}
                    {print}
                    END {
                     print "{{ queen.private }}    queen"
                     print "{{ bee1.private }}    bee1"
                     print "{{ bee2.private }}    bee2"
                     print "{{ bee3.private }}    bee3"
                     print "{{ bee4.private }}    bee4"
                     print "{{ bee5.private }}    bee5"
                     print "{{ bee6.private }}    bee6"
                     print "{{ bee7.private }}    bee7"
                    }

              runcmd:

                - echo "===== Handling ubuntu identity"
                - cp -n /etc/ssh/ssh_host_rsa_key /home/ubuntu/.ssh/id_rsa
                - cp -n /etc/ssh/ssh_host_rsa_key.pub /home/ubuntu/.ssh/id_rsa.pub
                - chown ubuntu:ubuntu /home/ubuntu/.ssh/*
                - sed -i "/StrictHostKeyChecking/s/^.*$/    StrictHostKeyChecking no/" /etc/ssh/ssh_config

                - echo "===== Updating /etc/hosts"
                - cp -n /etc/hosts /etc/hosts.original
                - awk -f /root/hosts.awk /etc/hosts >/etc/hosts.new && mv /etc/hosts.new /etc/hosts

                - echo "===== Installing docker"
                - curl -sSL https://get.docker.com/ | sh
                - docker daemon -H tcp://0.0.0.0:2375 -H unix:///var/run/docker.sock
                - usermod -aG docker ubuntu
                - su ubuntu -c "docker run hello-world"

                - echo "===== Running consul"
                - docker run -d -p 8500:8500 --name=consul -h {{ node.name }} progrium/consul -server -bootstrap -advertise {{ node.private }}

                - echo "===== Running swarm manager"
                - docker run -d -p 4000:4000 --name=swarmMgr swarm manage -H :4000 --advertise {{ node.private }}:4000  consul://{{ node.private }}:8500
                - docker ps

  - bees: # some bees contributing to the swarm

      domain: *domain
      ethernet: *ethernet
      nodes:
        - bee[1..7]:

            description: "#bee #docker #swarm #ubuntu"

            information:
              - "this is a Docker node contributing to the full swarm"
              - "connect remotely with:"
              - "$ ssh ubuntu@{{ node.public }}"

            appliance: 'Ubuntu 14'

            cpu: 8
            memory: 32

            glue:
              - internet 22

            monitoring: essentials

            cloud-config:

              hostname: "{{ node.name }}"

              packages:
                - ntp

              write_files:

                - path: /root/hosts.awk
                  content: |
                    #!/usr/bin/awk -f
                    /^{{ queen.private }}/ {next}
                    /^{{ bee1.private }}/ {next}
                    /^{{ bee2.private }}/ {next}
                    /^{{ bee3.private }}/ {next}
                    /^{{ bee4.private }}/ {next}
                    /^{{ bee5.private }}/ {next}
                    /^{{ bee6.private }}/ {next}
                    /^{{ bee7.private }}/ {next}
                    {print}
                    END {
                     print "{{ queen.private }}    queen"
                     print "{{ bee1.private }}    bee1"
                     print "{{ bee2.private }}    bee2"
                     print "{{ bee3.private }}    bee3"
                     print "{{ bee4.private }}    bee4"
                     print "{{ bee5.private }}    bee5"
                     print "{{ bee6.private }}    bee6"
                     print "{{ bee7.private }}    bee7"
                    }

              runcmd:

                - echo "===== Handling ubuntu identity"
                - cp -n /etc/ssh/ssh_host_rsa_key /home/ubuntu/.ssh/id_rsa
                - cp -n /etc/ssh/ssh_host_rsa_key.pub /home/ubuntu/.ssh/id_rsa.pub
                - chown ubuntu:ubuntu /home/ubuntu/.ssh/*
                - sed -i "/StrictHostKeyChecking/s/^.*$/    StrictHostKeyChecking no/" /etc/ssh/ssh_config

                - echo "===== Updating /etc/hosts"
                - cp -n /etc/hosts /etc/hosts.original
                - awk -f /root/hosts.awk /etc/hosts >/etc/hosts.new && mv /etc/hosts.new /etc/hosts

                - echo "===== Installing docker"
                - curl -sSL https://get.docker.com/ | sh
                - docker daemon -H tcp://0.0.0.0:2375 -H unix:///var/run/docker.sock
                - usermod -aG docker ubuntu
                - su ubuntu -c "docker run hello-world"

                - echo "===== Running swarm"
                - sleep 1m
                - docker run -d --name=swarm swarm join --advertise={{ node.private }}:2375 consul://{{ queen.private }}:8500
                - docker ps



